---
title: "Seurat Label Transfer"
author: 
 - Richard_Green
 - Lucas Graybuck
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    df_print: paged
    self_contained: true
params:
  in_file: system.file("testdata/pbmc_1k_v3_filtered_feature_bc_matrix.h5", package = "SeuratLabeler")
  out_h5: tempfile(fileext = ".h5")
  out_tbl: tempfile(fileext = ".csv")
---

```{r Load Libraries}
library(Seurat)
library(SeuratLabeler)
library(ggplot2)
```

Declare start
```{r Declare start}
stm("Starting Seurat PBMC Label Transfer")
```

Load Reference Dataset
```{r Load Reference}
stm("Loading Reference from SeuratLabeler package")
reference_so <- variable_pbmc_10k_v3
```

Load Query Dataset
```{r Load Query}
stm(paste("Loading query from", params$in_file))
query_data <- Read10X_h5(filename = params$in_file)
query_so <- CreateSeuratObject(counts = query_data)
```

Normalize Query Dataset
```{r Normalize Query}
stm("Normalizing query dataset")
query_so <- NormalizeData(object = query_so)
```

Find Anchors
```{r Find Transfer Anchors}
stm("Finding Transfer Anchors")
transfer_anchors <- FindTransferAnchors(reference = reference_so,
                                        query = query_so,
                                        features = VariableFeatures(object = reference_so),
                                        reduction = "cca")
```

Transfer labels
```{r Label Transfer}
stm("Transfering labels")
label_predictions <- TransferData(anchorset = transfer_anchors,
                                  refdata = reference_so$celltype)
query_so <- AddMetaData(object = query_so,
                        metadata = label_predictions)
```


```{r Session Info}
sessionInfo()
```
